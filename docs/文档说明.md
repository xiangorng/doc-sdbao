# 文档说明


## 默认约定

**金额**：以分为单位，如 1 元，需传递 100

**日期格式**：`yyyy-MM-dd`，**时间格式**：`yyyy-MM-dd HH:mm:ss`

**加密方式**：使用` AES `算法对称加密方式对要传输的报文进行加密，传输的是密文。加密用的密钥由「`水滴保险`」提供。 详情见：[参数详解](文档说明?id=参数详解)

**幂等性**：鉴于此前出现过的问题，特将接口的幂等性放在这里重点说明。
如果第一次出保成功，第二次重复请求的话，贵司应该直接返回此订单到目前为止的最终状态，即：成功，的结果（包括保单号），而不应该返回失败（订单号重复之类的错误提示）。同理，退保时，如果已经退保成功了，则再次重复退保时，仍然返回成功，而不应该返回失败(已退保，不能再退)。
> 简而言之，只关注业务环节的结果，不关注本次请求的结果。（而不是上次的请求结果）
> 大多数接口以 `orderNo`（订单号）作为幂等性标识；除外举例：续期接口，续期接口所有期数订单号都是同一个，所以需要用orderNo和期数一起做为表识


## 简单要求

### 测试环境

贵司需要保证测试环境的长期稳定性

### 生产环境

#### 承保

考虑到接口可能会不稳定，延误到用户的出保，贵司需要对「水滴保险」传过的出保请求， 不做保险开始时间的校验（有个时间误差范围就可以了，不必完全放开）。
贵司需要保证保单号的唯一性,做好保单号去重和校验逻辑。
如果一个订单请求中部分保单返回成功，部分返回失败，水滴保险会针对此订单或只选其中的若干保单重新发送出保请求，贵司需要返回该订单在本次请求中的所有保单号，注意同一被保险人上次返回和重新发送请求的保单号需要一致。
每一个请求和响应数据都应该被加密。

#### 退保
同承保，贵司需要对 「水滴保险」 传过去的退保请求，不做退保时间校验. 要求中提到贵司对于请求不做时间上的校验，基本原因解释如下：因为我们系统有自动重试的机制，如果说在合法的时间内发出接口请求，因为某些外部原因导致此次请求失败，而后重试的时候，可能已经处于非法时间段内了，这时候保险公司不应该限制这种重试性的请求。
但如果贵司商务上要求必须要校验时间，那么应当充分考虑允许一个合理的时间误差范围。


## 交互模式

属性 | 规则
:---|:---
使用协议 | HTTPS 请求响应模式
数据格式 | text/plain 
传参方式 | POST
参数 | String（加密后的密文）
应答模式 | 同步
端口限制 | 无

### 安全机制
  1. 整个请求或回复的 JSON 进行 `AES` 对称加密
  2. 测试环境密钥：`0123456789ABCDEF`
  3. 将「水滴保险」与保险公司约定的 key 按照特定的规则生成 sign，将 sign 放入请求的 headers 中。生成规则见[参数详解](文档说明?id=参数详解)
  4. 测试环境 key ：`123456`

## 参数详解

### headers

在发送 POST 请求时需要在 headers 中增加 supplierNo、timeStamp、和 sign 等参数

#### 字段列表

字段 | 名称 | 类型 | 必传 | 备注
:-- |:-- |:-- |:-- |:-- |
supplierNo | 合作商编号 | String | Y | 水滴公司分配给合作商的标识码
timeStamp | 时间戳 |String | Y | `yyyy-MM-dd HH:mm:ss`
orderNo | 订单号 | String | Y | 用于做sign的计算
sign | 校验码 | String | Y |
integritySign | 完整性校验码  | String | Y |

#### sign计算方式

```java
sign = Md5 (key + supplierNo + interfaceType + orderNo)
```

- `key`
  由「水滴保险」生成，线下通知保险公司
- `supplierNo`
  由「水滴保险」分配给合作商的标识码
- `interfaceType`
  **核保接口**: proposalOrder;
  **承保接口**: policyOrder;
  **退保试算**: refundCal;
  **退保/失效接口**: refundOrder;
  **退保通知**: refundNotice;
  **续费接口**: renewOrder;
  **长险锁单申请**: renewLock;
  **长险扣费结果同步**: renewPay;
  **赠险出单**: policyFree;
  **数据同步**: dataTransfer;
  **保单升级接口**: upgradeOrder;
  **订单状态通知**: statusNotice;
  **回执确认**: orderReceipt;
  **电子保单查询**: queryPolicy;
  **预核保接口**: preProposal;
  **出单同步接口**: orderTransfer;
  **订单查询接口**: queryOrder;
  **批改接口**: modifyOrder;
  **回访接口**: returnVisit;
  **回访通知接口**: visitNotice;
  **通知扣费接口**: policyOrder;
  **申请福利接口**: WelfareOrder;
  **福利状态通知**: WelfareNotice;
  **取消福利接口**: CancelWelfare;
  **保单查询接口**: downPolicy;
  
#### integritySign计算方式
  
```java
integritySign = Md5 (「Base64串」+ key)
「Base64串」 : 对body进行加密时生成的，在“body加密方法”中有详细说明
```

#### 举例

如下图:
![postman](/assets/postman.png)

### body

`body`中放入：
- 把当前接口的「请求参数」转换为 json
- 对`json`进行`AES`对称加密，得到「加密串」
- 将「加密串」再进行`Base64`加密后，得到「Base64串」
- 把「Base64串」进行`UTF-8`编码，然后放入`Entity`中
加密代码示例：
![postman](/assets/encode.png)

### 特别说明
随着业务拓展，业务参数字段将来可能会增加新的字段。贵公司应务必保证有新字段时接口不会报错

## 接口列表

名称 | 类型 | 发起方 | 描述
:-- | :-- | :-- | :--
核保接口 | 新契约 | 水滴保险 | 用户在商家购买保障型保险，由水滴向保险公司发起核保，保险公司返回核保结果信息。
承保接口 | 新契约 | 水滴保险 | 用户对购买保障型保险付出成功以后，由水滴发起出单请求。
退保试算 | 退保 | 水滴保险 | 用户在水滴平台申请退保前调用保司接口，查看本次退保应退还给用户的保费
退保/失效接口 | 退保 | 水滴保险 | 用户在水滴平台申请退保后（或者分期产品用户超过宽限期未续费），由水滴发起退保请求，保险公司返回退保结果
退保通知 | 退保 | 保险公司 | 用户线下联系保险公司进行退保的，保险公司应调用此接口，通知水滴。
续费接口 | 续期续费 | 水滴保险 | 水滴在进行用户续期扣费操作后，跟进扣费结果通知保险公司，保险公司需要针对结果进行处理。
长险锁单申请 | 续期续费 | 水滴保险 | 长险产品续费前，调用保司接口通知保司准备扣费，并锁定该保单状态为本次续费前不可更改
长险扣费结果同步 | 续期续费 | 水滴保险 | 长险产品续费，支付完成后，调用保司接口通知本次续费结果
赠险出单 | 辅助功能 | 水滴保险 | 赠险产品出单，赠险产品出单即为承保
数据同步 | 辅助功能 | 水滴保险 | 水滴保险按照约定定时同步订单数据到保险公司
保单升级接口 | 辅助功能 | 水滴保险 | 水滴保险按照约定调用保司此接口进行保单升级
订单状态通知 | 辅助功能 | 保险公司 | 电销共建产品，保险公司异步通知水滴承保结果，或者通过此接口通知电子保单地址
回执确认 | 辅助功能 | 水滴保险 | 用户确认承保成功后，由水滴通知保司
预核保接口 | 核保辅助 | 水滴保险 | 核保之前预先调用中间核保公司接口，进行预核保
出单同步接口 | 核保辅助 | 水滴保险 | 出单成功后同步出单消息给中间核保公司
订单查询接口 | 承保辅助 | 水滴保险 | 针对状态未知或异常的订单，水滴保险会定时调用该接口查询保司的订单转态，尽最大可能保持双方订单状态一致
批改接口 | 承保辅助 | 水滴保险 | 水滴主动发起，修改保单状态
通知扣费接口 | 承保辅助 | 水滴保险 | 电销专用，质检完成后通过本接口通知保司可以扣费
申请福利接口 | 新契约 | 水滴保险 | 用户申请福利，由水滴向合作机构发起申请，保险公司返回申请结果信息
福利状态通知 | 辅助功能 | 合作机构 | 合作机构通过此接口通知体检状态及相关信息
取消福利接口 | 退保 | 水滴保险 | 用户在水滴平台申请取消后（或者超过时限失效），由水滴发起请求，合作机构返回结果
保单查询接口 | 辅助功能 | 合作机构 | 水滴调用保司接口查询下载电子保单

## 接口地址说明
1. 不同接口使用不同的接口地址
2. 接口地址格式为：hostUrl + interfaceType（接口类型，在[参数详解] 项目中有详细说明）
3. hostUrl由保险公司自定义。联调测试时只需要把hostUrl告知水滴保险测试人员即可
4. 举例：
    1. 已知，保险公司定义的hostUrl为：http://www/woxiaxiede/baoxian/ceshi
    2. 则，核保接口为：http://www/woxiaxiede/baoxian/ceshi/proposalOrder
    3. 则，承保接口为：http://www/woxiaxiede/baoxian/ceshi/policyOrder
5. 通知类（保司请求水滴）接口的接口地址，线下通知保司。测试环境地址在联调时提供，正式环境地址测试完成，正式上线前提供
